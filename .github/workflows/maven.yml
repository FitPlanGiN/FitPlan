name: SpringBoot CI/CD Pipeline (Helm)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

    #  - name: Build and push images using spring-boot:build-image
       # env:
       #   DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      #  run: |
       #   mvn clean spring-boot:build-image -DskipTests
  
      #- name: Building and pushing fitplanfrontend
       # run: |
        #  docker build --no-cache -t ${{ secrets.DOCKER_USERNAME }}/fitplanfrontend:latest .
         # echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
         # docker push ${{ secrets.DOCKER_USERNAME }}/fitplanfrontend:latest
       # working-directory: fitplanfrontend          

      - name: Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: 'fitplan'
          location: 'europe-central2-a'

      - name: Set up kubectl
        run: |
          kubectl config use-context gke_${{ secrets.PROJECT_ID }}_europe-central2-a_fitplan

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Check if MySQL disk exists
        run: |
          if ! gcloud compute disks describe mysql-disk --zone=europe-central2-a > /dev/null 2>&1; then
            gcloud compute disks create mysql-disk --size=10Gi --zone=europe-central2-a
          else
            echo "MySQL disk already exists, skipping creation."
          fi

      # Remove conflicting secrets (if necessary)
    #  - name: Remove existing secrets
       # run: |
       #   kubectl delete secret fitplan-helm-secrets --ignore-not-found

      - name: Deploy common-config
        run: |
          helm upgrade --install common-config ./fitplan-helm/charts/common-config --wait --force

      - name: Deploy configserver
        run: |
          helm upgrade --install configserver ./fitplan-helm/charts/configserver --wait --force

      - name: Deploy mysql
        run: |
          helm upgrade --install mysql ./fitplan-helm/charts/mysql --wait --force

      - name: Deploy mongodb
        run: |
          helm upgrade --install mongodb ./fitplan-helm/charts/mongodb --wait --force

      - name: Deploy keycloak-mysql
        run: |
          helm upgrade --install keycloak-mysql ./fitplan-helm/charts/keycloak-mysql --wait --force

      - name: Deploy zookeeper
        run: |
          helm upgrade --install zookeeper ./fitplan-helm/charts/zookeeper --wait --force

      - name: Deploy broker
        run: |
          helm upgrade --install broker ./fitplan-helm/charts/broker --wait --force

      - name: Deploy kafka-ui
        run: |
          helm upgrade --install kafka-ui ./fitplan-helm/charts/kafka-ui --wait --force

      - name: Deploy schema-registry
        run: |
          helm upgrade --install schema-registry ./fitplan-helm/charts/schema-registry --wait --force

      - name: Deploy keycloak
        run: |
          helm upgrade --install keycloak ./fitplan-helm/charts/keycloak --wait --force

      - name: Deploy prometheus
        run: |
          helm upgrade --install prometheus ./fitplan-helm/charts/prometheus --wait --force

      - name: Deploy loki
        run: |
          helm upgrade --install loki ./fitplan-helm/charts/loki --wait --force

      - name: Deploy tempo
        run: |
          helm upgrade --install tempo ./fitplan-helm/charts/tempo --wait --force

      - name: Deploy grafana
        run: |
          helm upgrade --install grafana ./fitplan-helm/charts/grafana --wait --force

      - name: Deploy exercise
        run: |
          helm upgrade --install exercise ./fitplan-helm/charts/exercise --wait --force

      - name: Deploy fitplan-ingress
        run: |
          helm upgrade --install fitplan-ingress ./fitplan-helm/charts/fitplan-ingress --wait --force

      - name: Deploy fitplanfrontend
        run: |
          helm upgrade --install fitplanfrontend ./fitplan-helm/charts/fitplanfrontend --wait --force

      - name: Deploy gateway
        run: |
          helm upgrade --install gateway ./fitplan-helm/charts/gateway --wait --force

      - name: Deploy notification
        run: |
          helm upgrade --install notification ./fitplan-helm/charts/notification --wait --force

      - name: Deploy validation
        run: |
          helm upgrade --install validation ./fitplan-helm/charts/validation --wait --force

      - name: Deploy workout
        run: |
          helm upgrade --install workout ./fitplan-helm/charts/workout --wait --force

      # Run frontend connection test
      - name: Run connection test to fitplanfrontend
        run: |
          helm test fitplan-helm --logs
